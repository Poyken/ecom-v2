generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id                    String    @id @default(uuid()) @db.Uuid
  name                  String
  domain                String    @unique
  status                String    @default("active")
  settings              Json      @default("{}")
  subscriptionPlan      String    @default("starter") // starter, professional, enterprise
  subscriptionExpiresAt DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  users                 User[]
  categories            Category[]
  brands                Brand[]
  products              Product[]
  skus                  Sku[]
  collections           Collection[]
  warehouses            Warehouse[]
  inventoryItems        InventoryItem[]
  orders                Order[]
  payments              Payment[]

  @@map("tenants")
}

model User {
  id               String    @id @default(uuid()) @db.Uuid
  tenantId         String    @db.Uuid
  email            String
  passwordHash     String
  firstName        String
  lastName         String
  role             String    @default("customer")
  isActive         Boolean   @default(true)
  emailVerified    Boolean   @default(false)
  emailVerifiedAt  DateTime?
  lastLoginAt      DateTime?
  acceptTerms      Boolean   @default(false)
  marketingConsent Boolean   @default(false)
  metadata         Json      @default("{}")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders           Order[]

  @@unique([tenantId, email])
  @@map("users")
}

model Category {
  id          String     @id @default(uuid()) @db.Uuid
  tenantId    String     @db.Uuid
  parentId    String?    @db.Uuid
  name        String
  slug        String
  description String?
  image       String?
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  products    Product[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("categories")
}

model Brand {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  name        String
  slug        String
  description String?
  logo        String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products    Product[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("brands")
}

model Product {
  id               String          @id @default(uuid()) @db.Uuid
  tenantId         String          @db.Uuid
  categoryId       String?         @db.Uuid
  brandId          String?         @db.Uuid
  name             String
  slug             String
  description      String?         @db.Text
  shortDescription String?         @db.Text
  images           Json            @default("[]")
  status           String          @default("draft") // draft, published, archived
  basePrice        Decimal         @db.Decimal(10, 2)
  salePrice        Decimal?        @db.Decimal(10, 2)
  costPrice        Decimal?        @db.Decimal(10, 2)
  weight           Decimal?        @db.Decimal(8, 3)
  dimensions       Json? // {length, width, height, unit}
  tags             Json            @default("[]")
  sortOrder        Int             @default(0)
  isActive         Boolean         @default(false)
  metadata         Json            @default("{}")
  publishedAt      DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category         Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  brand            Brand?          @relation(fields: [brandId], references: [id], onDelete: SetNull)
  options          ProductOption[]
  skus             Sku[]
  collections      ProductsOnCollections[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([categoryId])
  @@index([status])
  @@index([deletedAt])
  @@map("products")
}

model Collection {
  id          String                  @id @default(uuid()) @db.Uuid
  tenantId    String                  @db.Uuid
  name        String
  slug        String
  description String?                 @db.Text
  image       String?
  isActive    Boolean                 @default(true)
  metadata    Json                    @default("{}")
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  deletedAt   DateTime?
  tenant      Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products    ProductsOnCollections[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("collections")
}

model ProductsOnCollections {
  productId    String     @db.Uuid
  collectionId String     @db.Uuid
  sortOrder    Int        @default(0)
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@id([productId, collectionId])
  @@map("products_on_collections")
}

model ProductOption {
  id        String        @id @default(uuid()) @db.Uuid
  tenantId  String        @db.Uuid
  productId String        @db.Uuid
  name      String // e.g., Color, Size
  sortOrder Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  product   Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  values    OptionValue[]

  @@index([productId])
  @@map("product_options")
}

model OptionValue {
  id          String        @id @default(uuid()) @db.Uuid
  tenantId    String        @db.Uuid
  optionId    String        @db.Uuid
  value       String // e.g., Blue, XL
  displayName String
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  option      ProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  skuValues   SkuValue[]

  @@index([optionId])
  @@map("option_values")
}

model Sku {
  id           String     @id @default(uuid()) @db.Uuid
  tenantId     String     @db.Uuid
  productId    String     @db.Uuid
  sku          String
  barcode      String?
  price        Decimal    @db.Decimal(10, 2)
  comparePrice Decimal?   @db.Decimal(10, 2)
  costPrice    Decimal?   @db.Decimal(10, 2)
  stock        Int        @default(0)
  trackInventory Boolean  @default(true)
  weight       Decimal?   @db.Decimal(8, 3)
  dimensions   Json?
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  skuValues    SkuValue[]
  stocks       InventoryItem[]
  orderItems   OrderItem[]

  @@unique([tenantId, sku])
  @@index([productId])
  @@map("skus")
}

model SkuValue {
  id            String      @id @default(uuid()) @db.Uuid
  tenantId      String      @db.Uuid
  skuId         String      @db.Uuid
  optionValueId String      @db.Uuid
  sku           Sku         @relation(fields: [skuId], references: [id], onDelete: Cascade)
  optionValue   OptionValue @relation(fields: [optionValueId], references: [id], onDelete: Cascade)

  @@unique([skuId, optionValueId])
  @@index([skuId])
  @@index([optionValueId])
  @@map("sku_values")
}

model Warehouse {
  id        String          @id @default(uuid()) @db.Uuid
  tenantId  String          @db.Uuid
  name      String
  code      String
  address   String?
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stocks    InventoryItem[]

  @@unique([tenantId, code])
  @@map("warehouses")
}

model InventoryItem {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  skuId       String    @db.Uuid
  warehouseId String    @db.Uuid
  quantity    Int       @default(0)
  reserved    Int       @default(0)
  reorderPoint Int      @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sku         Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([skuId, warehouseId])
  @@map("inventory_items")
}

model Order {
  id              String      @id @default(uuid()) @db.Uuid
  tenantId        String      @db.Uuid
  userId          String?     @db.Uuid
  orderNumber     String
  status          String      @default("pending") // pending, processing, shipped, delivered, cancelled
  currency        String      @default("VND")
  subtotal        Decimal     @db.Decimal(12, 2)
  taxAmount       Decimal     @default(0) @db.Decimal(12, 2)
  shippingAmount  Decimal     @default(0) @db.Decimal(12, 2)
  discountAmount  Decimal     @default(0) @db.Decimal(12, 2)
  total           Decimal     @db.Decimal(12, 2)
  shippingAddress Json?
  billingAddress  Json?
  notes           String?     @db.Text
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  tenant          Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  items           OrderItem[]
  payments        Payment[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  orderId     String   @db.Uuid
  skuId       String   @db.Uuid
  productName String
  skuString   String
  quantity    Int
  unitPrice   Decimal  @db.Decimal(12, 2)
  totalPrice  Decimal  @db.Decimal(12, 2)
  attributes  Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sku         Sku      @relation(fields: [skuId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([skuId])
  @@map("order_items")
}

model Payment {
  id                String    @id @default(uuid()) @db.Uuid
  tenantId          String    @db.Uuid
  orderId           String    @db.Uuid
  gateway           String // vnpay, cod, stripe
  transactionId     String?
  status            String    @default("pending") // pending, completed, failed, refunded
  amount            Decimal   @db.Decimal(12, 2)
  currency          String    @default("VND")
  gatewayResponse   Json?
  processedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([transactionId])
  @@map("payments")
}
